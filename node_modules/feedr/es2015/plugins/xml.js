'use strict';

module.exports.parse = function parseXML(_ref, next) {
	var feedr = _ref.feedr;
	var feed = _ref.feed;
	var response = _ref.response;
	var data = _ref.data;

	// Detect
	var isXML = feed.parse === 'xml' || ['.xml', '.atom', '.rss', '.rdf', '.html', '.html'].indexOf(feed.extension) !== -1 || response.headers['content-type'].indexOf('xml') !== -1 || response.headers['content-type'].indexOf('html') !== -1;
	if (!isXML) {
		next();
		return;
	}

	// XML options
	var xml2jsOptions = require('extendr').deep({}, feedr.config.xml2jsOptions || {}, feed.xml2jsOptions || {});

	// Prepare Parse
	var xml2js = require('xml2js');
	var parser = new xml2js.Parser(xml2jsOptions);
	parser.on('end', function (data) {
		next(null, data);
	});

	// Parse
	try {
		parser.parseString(data.toString().trim());
	} catch (err) {
		next(err);
	}
};